## Post-Exploitation

Once we've compromised the domain, depending on the assessment type, our work is not over. There are many things we can do to add additional value to our clients. If the goal of the assessment was to reach Domain Admin and nothing further, then we are done and should make sure we have all of our command/log output, scan data, and screenshots and continue drafting the report. If the assessment was goal focused (i.e., gain access to a specific database) we should continue working towards that goal. Domain Admin rights may be just the start as there could be other networks, domains, or forests in play that we will need to find our way into. If the assessment is more open ended and the client asked us to demonstrate as much impact as possible there are quite a few things we can do to add value and help them improve their security posture.



### Domain Controller pwn

DC Admin hash

Administrator:fd1f7e5564060258ea787ddbb6e6afa2

![dc](/Post-Exploitation/images/dc-pwn-1.png) 


![dc](/Post-Exploitation/images/dc-pwn-2.png) 

	secretsdump.py LOCAL -system SYSTEM.SAVE -sam SAM.SAVE -security SECURITY.SAVE                  
	Impacket for Exegol - v0.10.1.dev1+20230909.241.3001b261 - Copyright 2022 Fortra - forked by ThePorgs

	[*] Target system bootKey: 0x355a7abc42fc90875740e499c937b0b5
	[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
	Administrator:500:aad3b435b51404eeaad3b435b51404ee:a678b5e7cc4c143b1d76a69ddf14c3ae:::
	Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
	DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
	[-] SAM hashes extraction for user WDAGUtilityAccount failed. The account doesn't have hash information.
	[*] Dumping cached domain logon information (domain/username:hash)
	[*] Dumping LSA Secrets
	[*] $MACHINE.ACC 
	$MACHINE.ACC:plain_password_hex:6fb87c95629f8815074f26a01625a59eaaef289a215a4d5bd09d55d926956b26b90401deb6ef66b60bb9c7930dd33b6b7495791f1d05454b579db3965417ddec964dffb08878055b68dbf2902221ea814f6645214463499ee09001693a58ee443fe8c03d71c4083dc3d2018e366ffaa73fa11a39616b5814cdbcf28319d052a4f82301a459523d0fa4cf40e84116c05b2379da5ef23b4bba5d8c4183c5352029d9a17f3a7762ff5a5162877dc65fc87fdcd9bd38966aeac7a2baca1f7317d39d36d8c8854e2aec17bc725026516d59cc927611420837b03b911579683a9a75ce1531e87ec1842bafcf0e22d372f2e6b1
	$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:27fce1aa344fa53f072303806d496a0b
	[*] DPAPI_SYSTEM 
	dpapi_machinekey:0x62c67d3115e3cf5000667bddd06086b471a3fec6
	dpapi_userkey:0x860cfa00b9a277abfd05d4251b545a6d427d3cb9
	[*] NL$KM 
	 0000   21 0C E6 AC 8B 08 9B 39  97 EA D9 C6 77 DB 10 E6   !......9....w...
	 0010   2E B2 53 43 7E B8 06 64  B3 EB 89 B1 DA D1 22 C7   ..SC~..d......".
	 0020   11 83 FA 35 DB 57 3E B0  9D 84 59 41 90 18 7A 8D   ...5.W>...YA..z.
	 0030   ED C9 1C 26 FF B7 DA 6F  02 C9 2E 18 9D CA 08 2D   ...&...o.......-
	NL$KM:210ce6ac8b089b3997ead9c677db10e62eb253437eb80664b3eb89b1dad122c71183fa35db573eb09d84594190187a8dedc91c26ffb7da6f02c92e189dca082d
	[*] Cleaning up... 


### Domain Password Analysis - Cracking NTDS

After we have dumped the NTDS database we can perform offline password cracking with Hashcat. Once we've exhausted all possible rules and wordlists on our cracking rig we should use a tool such as [DPAT](https://github.com/clr2of8/DPAT) to perform a domain password analysis. This can nicely compliment findings such as Weak Active Directory Passwords Allowed, which we noted down after a successful password spraying attack earlier. This analysis can help drive the point home and can be a power visual. Our analysis can be included in the appendices of the report with metrics such as:

> - Number of password hashes obtained
> - Number of password hashes cracked
> - Percent of password hashes cracked
> - Top 10 passwords
> - Password length breakdown
> - Number of Domain Admin passwords cracked
> - Number of Enterprise Admin passwords cracked


### Active Directory Security Audit

As discussed in the Active Directory Enumeration & Attacks module, we can provide extra value to our clients by digging deeper into Active Directory and finding best practice recommendations and delivering them in the appendices of our report. The tool [PingCastle](https://www.pingcastle.com/) is excellent for auditing the overall security posture of the domain and we can pull many different items from the report it generates to give our client recommendations on additional ways they can harden their AD environment. This type of "above and beyond the call of duty" work can build good will with our customers and lead to both repeat business and referrals. Its a great way to set ourselves apart and demonstrate the risks that plague AD environments and show our deep understanding of the client's network.


### Hunting for Sensitive Data / Hosts

Once we've gained access to the Domain Controller we can likely access most any resources in the domain. If we want to demonstrate impact for our clients a good spot to start is going back to the file shares to see what other types of data we can now view. As discussed in the Documentation & Reporting module, we should make sure to just take screenshots showing a file listing if we find a particularly sensitive file share, and not open individual files and take screenshots or remove any files from the network.

Let's go back to the **Department Shares** share and see what else we can find.

![Deparment Shares](/Post-Exploitation/images/dept-shares.png) 

Depending on the client industry and business, there are various things we can go after to demonstrate impact. HR data such as salaries and bonuses should be well-protected, R&D information could potentially hurt a company if it is leaked so they should have extra controls in place. It can be a good practice to not allow Domain Admins to have blanket access to all data, because if one account is compromised then everything will be. Some companies will have a separate site or non-domain joined file share or backup server to house sensitive data. In our case Inlanefreight has asked us to test if we can gain access to any hosts in the 172.16.9.0/23 subnet. This is their management network and houses sensitive servers that should be not directly accessible from hosts in the principal domain and gaining Domain Admin rights should not lead to immediate access.

Within the **private IT** share we can see two subdirectories: **Development and Networking.** The Development subdirectory houses the backup script that we obtained earlier. Let's take a look in the Networking subdirectory.

We can see SSH private keys for three different users. This is interesting.

![SSH](/Post-Exploitation/images/ssh-keys.png) 

Can any of these users be leveraged to access a host in the protected network?

Looking at the network adapters on the Domain Controllers we can see that it has a second NIC in the 172.16.9.0 network.

	Ethernet adapter Ethernet1:

	   Connection-specific DNS Suffix  . :
	   Description . . . . . . . . . . . : vmxnet3 Ethernet Adapter #2
	   Physical Address. . . . . . . . . : 00-50-56-B0-2E-2C
	   DHCP Enabled. . . . . . . . . . . : No
	   Autoconfiguration Enabled . . . . : Yes
	   Link-local IPv6 Address . . . . . : fe80::a8e4:3dfb:f43c:f901%7(Preferred)
	   IPv4 Address. . . . . . . . . . . : 172.16.9.3(Preferred)
	   Subnet Mask . . . . . . . . . . . : 255.255.254.0
	   Default Gateway . . . . . . . . . : 172.16.9.1
	   DHCPv6 IAID . . . . . . . . . . . : 167792726
	   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-2E-6E-9C-85-00-50-56-B0-FD-72
	   DNS Servers . . . . . . . . . . . : ::1
		                                  172.16.9.1
	   NetBIOS over Tcpip. . . . . . . . : Enabled


Typing arp -a to view the arp table does not yield anything interesting. We can use PowerShell to perform a ping sweep and attempt to identify live hosts.


	$ 1..100 | % {"172.16.9.$($_): $(Test-Connection -count 1 -comp 172.16.9.$($_) -quiet)"}
		  
	[proxychains] Strict chain  ...  127.0.0.1:1080  ...  172.16.8.3:5985  ...  OK
	[proxychains] Strict chain  ...  127.0.0.1:1080  ...  172.16.8.3:5985  ...  OK                                                  
	172.16.9.1: False 
	172.16.9.2: False 
	172.16.9.3: True                                                                                                                
	172.16.9.4: False 
	172.16.9.5: False
	172.16.9.6: False
	172.16.9.7: False
	172.16.9.8: False
	172.16.9.9: False
	172.16.9.10: False
	

We can see one live host, 172.16.9.25, that perhaps one of the SSH private keys will work against. Let's get to work. First download the SSH keys via our evil-winrm connection to the Domain Controller.


### The Double Pivot - MGMT01

Now there are a few ways to do this next part, we'll take the long route so we can ultimately SSH directly into the 172.16.9.25 host from our attack box, performing a bit of a mindbending double pivot in the process. Here is what we are trying to achieve, starting from our attack host and pivoting through the dmz01 and DC01 hosts to be able to SSH directly into the MGMT01 host two hops away directly from our attack host.

**Attack host --> dmz01 --> DC01 --> MGM01**

We'll need to establish a reverse shell from the dmz01 box back to our attack host. We can do this the same we way did in the Internal Information Gathering section, creating an ELF payload, uploading it to the target and executing it to catch a shell. Start by creating the ELF payload and uploading it back to the dmz01 host via SCP if you removed it.

Next, set up the **Metasploit exploit/multi/handler.**

![DMZ Shell](/Post-Exploitation/images/dmz-shell.png) 

![DMZ Listener](/Post-Exploitation/images/dmz-listener.png) 

Once again, execute the dmz443.elf file on the target system:

Catch the Meterpreter shell using the multi/handler.

![DMZ Meterpreter](/Post-Exploitation/images/dmz-met.png) 

Next, set up a local port forwarding rule to forward all traffic destined to port 1234 on dmz01 to port 8443 on our attack host.

![DMZ Forward](/Post-Exploitation/images/dmz-forward.png) 

Next, create an executable payload that we'll upload to the Domain Controller host.

![DC Shell](/Post-Exploitation/images/dc-shell.png) 

Upload the payload to the DC.

Background the Meterpreter session

![DC Listener](/Post-Exploitation/images/dc-listener.png) 

Execute the payload on the DC and, if all goes to plan, we'll catch it in our handler.

Checking on our handler and we see the incoming connection. It appears to come from 0.0.0.0 because our port forwarding rule set earlier has specified that all traffic destined for our host on port 1234 should be directed to (our listener) on port 8443.

![Sessions](/Post-Exploitation/images/met-sessions.png) 

For our next trick we'll set up a route to the **172.16.9.0/23** subnet.

![Routes](/Post-Exploitation/images/add-route.png) 

We can confirm this by checking the MSF routing table.

![Routes](/Post-Exploitation/images/routes.png) 

Now we need to set up a socks proxy which is the final step before we can communicate directly with the 172.16.9.0/23 network from our attack host.

![Socks Proxy](/Post-Exploitation/images/socks-proxy.png) 

Edit the /etc/proxychains.conf file to use port 9050 that we specified above. If you already have a line in there from earlier, comment it out or replace the port number.

Now we can test this out by running Nmap against the target, and we confirm that we are able to scan it.

![Nmap](/Post-Exploitation/images/nmap.png) 

Finally, we can try each SSH key with proxychains to attempt to connect to the host. We can collect each username by the SSH key filename. In our case the key for ssmallsadm works (don't forget to chmod 600 the file or we won't be able to connect).

![SSH](/Post-Exploitation/images/ssh.png) 

As a final step we'll enumerate the target system, checking for local privilege escalation opportunities. If we can get root-level access we'll have fulfilled the client's main goal, as they stated that this server holds their "crown jewels", or most important data. During our enumeration we do a Google search based off of the Kernel version and see that it's likely vulnerable to the [DirtyPipe](https://www.cisa.gov/uscert/ncas/current-activity/2022/03/10/dirty-pipe-privilege-escalation-vulnerability-linux), CVE-2022-0847. We can read an excellent explanation of this vulnerability on the Hack The Box blog.

We'll use exploit-2 from this [GitHub](https://github.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits) repo. Since we have SSH access to the system, we can create a file with Vim and paste the exploit code in. We then must compile it, and luckily gcc is present on the system.

![Dirty Pipe](/Post-Exploitation/images/dirty-pipe.png) 


We must run the exploit against a SUID binary to inject and overwrite memory in a root process. So first we need to search SUID binaries on the system.

![SUID](/Post-Exploitation/images/suid.png) 

Finally, we'll run the exploit against the **/usr/lib/openssh/ssh-keysign SUID binary** and drop into a root shell.

	$ ./dirtypipe /usr/lib/openssh/ssh-keysign

![Root](/Post-Exploitation/images/root.png) 

From here we could perform post-exploitation of the file system to prove the level of access we achieved.

### Data Exfiltration Simulation

Some clients may want to test their Data Loss Prevention (DLP) capabilities, so we could experiment with various ways to exfiltrate mock data from their network to see if we are detected. We should work with the client to understand what types of data they are trying to protect and proceed accordingly. It's best to use mock data so we don't have to deal with any highly sensitive client data on our testing system.

### Attacking Domain Trusts

If there are any domain trusts we could use our skills to enumerate these relationships and exploit either a child --> parent trust relationship, intra-forest trust, or an external forest trust. Before doing so, we should check with the client to make sure the target domain is in scope for testing. Sometimes we'll compromise a less import domain and be able to use this access to fully take over the principal domain. This can provide a lot of value to the client as they may have set up trust relationships hastily as the result of a merger & acquisition or connecting to some other organization. Their domain may be well-hardened, but what if we are able to Kerberoast across a forest trust, compromise a partner forest, and then find an account in the partner forest that has full admin rights in our current domain. In this situation we could demonstrate to our client that the main weakness isn't in the domain we are testing in but another so they can proceed accordingly.

### Closing Thoughts

This section showed a sampling of the things we can do AFTER achieving Domain Admin in a client environment. Showing up, pwning the client and showing off how fast you got DA does no good for the client and does not help you and your firm retain clients and spread a solid reputation around. What we do after achieving Domain Admin is extremely important and this is where we can set ourselves apart from other testers who just run Responder, a few other tools and scripts, a Nessus scan, and issue a stock report and call it a day. Your report deliverable should demonstrate the worth of the penetration test your client is paying for and we can make sure they are happy and come back in the following years if we go above and beyond. This is not always possible due to contract restrictions and time-boxed assessments, but even if we can provide a little extra we're ahead of the pack. Keep in mind that the things we identify in our report can impact a client's funding for the following year and that funding likely includes penetration tests. We don't want to inflate the report with nonsensical findings, of course, but we can often identify many things that our client had never even considered and they and you will be better for it.
